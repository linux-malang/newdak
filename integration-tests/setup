# -*- mode: sh -*-
#
# Â© 2017-2018 Ansgar Burchardt <ansgar@debian.org>
# License: GPL-2+
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

if [[ ! -v DAK_INTEGRATION_TEST || ! -v DAK_ROOT ]]; then
  exit 1
fi

dak-setup() {
  local setupdir="${DAK_ROOT}/setup"

  export DAKBASE=$(mktemp -d)
  export DAKHOST=dak-master

  (cd ${setupdir}; ./init_db)
  if [[ ${PGUSER:-} != dak ]]; then
    psql -c "GRANT dak TO \"${PGUSER}\""
  fi
  psql -f ${setupdir}/current_schema.sql -d projectb >/dev/null
  unset PGDATABASE
  (cd ${setupdir}; ./init_core)

  mkdir ${DAKBASE}/etc ${DAKBASE}/bin ${DAKBASE}/keyrings ${DAKBASE}/tmp
  ln -s ${DAK_ROOT}/templates ${DAKBASE}/

  export DAK_CONFIG="${DAKBASE}/etc/dak.conf"
  (cd ${setupdir}; ./init_minimal_conf) > ${DAK_CONFIG}
  echo 'DB::Role "dak";' >> ${DAK_CONFIG}

  export PATH="${DAKBASE}/bin:${PATH}"
  ln -s ${DAK_ROOT}/dak/dak.py ${DAKBASE}/bin/dak

  dak update-db --yes
  dak init-dirs
}

dak-cleanup() {
  if [[ -v DAKBASE ]]; then
    rm -rf -- "${DAKBASE}"
  fi
}

trap dak-cleanup EXIT
dak-setup
